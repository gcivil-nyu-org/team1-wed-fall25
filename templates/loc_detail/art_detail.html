{% extends 'base.html' %}
{% load static %}

{% block title %}{{ art.title|default:"Untitled" }} - Artinerary{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/locdetail/locdetail.css' %}">
{% endblock %}

{% block content %}
<div class="art-detail-container">
    <div class="breadcrumb">
        <a href="{% url 'loc_detail:index' %}">‚Üê Back to Artworks</a>
    </div>

    <div class="detail-grid">
        <div class="detail-main">
            <div class="detail-header">
                <h1 class="detail-title">{{ art.title|default:"Untitled" }}</h1>
                {% if art.borough %}
                    <span class="art-badge">{{ art.borough }}</span>
                {% endif %}
            </div>

            {% if art.image %}
                <div class="detail-image">
                    {{ art.art_image|safe }}
                </div>
            {% else %}
                <div class="detail-image placeholder-image">
                    <p>No image available</p>
                </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="action-buttons" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button 
                    id="favorite-button" 
                    class="btn btn-outline-primary"
                    data-art-id="{{ art.id }}"
                    data-favorited="{{ is_favorited|yesno:'true,false' }}"
                >
                    <span class="heart {% if is_favorited %}favorited{% endif %}"><i class="fas fa-heart"></i></span>
                    <span id="favorite-text">{% if is_favorited %}Remove from Favorites{% else %}Add to Favorites{% endif %}</span>
                </button>

                <button 
                    id="add-to-itinerary-button" 
                    class="btn btn-outline-primary"
                    data-art-id="{{ art.id }}"
                    data-art-title="{{ art.title|default:'Untitled' }}"
                >
                    <span style="font-size: 20px;">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" class="pin">
                            <path d="M480-480q33 0 56.5-23.5T560-560q0-33-23.5-56.5T480-640q-33 0-56.5 23.5T400-560q0 33 23.5 56.5T480-480Zm0 400Q319-217 239.5-334.5T160-552q0-150 96.5-239T480-880q127 0 223.5 89T800-552q0 100-79.5 217.5T480-80Z"/>
                        </svg>
                    </span>
                    <span>Add to Itinerary</span>
                </button>
            </div>

            <div class="detail-section">
                <h2>Artist Information</h2>
                <p class="detail-artist">{{ art.artist_name|default:"Unknown Artist" }}</p>
            </div>

            {% if art.description %}
                <div class="detail-section">
                    <h2>Description</h2>
                    <p class="detail-description">{{ art.description }}</p>
                </div>
            {% endif %}

            <div class="detail-section">
                <h2>Details</h2>
                <div class="detail-info-grid">
                    {% if art.medium %}
                        <div class="info-item">
                            <span class="info-label">Medium</span>
                            <span class="info-value">{{ art.medium }}</span>
                        </div>
                    {% endif %}

                    {% if art.dimensions %}
                        <div class="info-item">
                            <span class="info-label">Dimensions</span>
                            <span class="info-value">{{ art.dimensions }}</span>
                        </div>
                    {% endif %}

                    {% if art.year_created %}
                        <div class="info-item">
                            <span class="info-label">Year Created</span>
                            <span class="info-value">{{ art.year_created }}</span>
                        </div>
                    {% endif %}

                    {% if art.year_dedicated %}
                        <div class="info-item">
                            <span class="info-label">Year Dedicated</span>
                            <span class="info-value">{{ art.year_dedicated }}</span>
                        </div>
                    {% endif %}

                    {% if art.agency %}
                        <div class="info-item">
                            <span class="info-label">Agency</span>
                            <span class="info-value">{{ art.agency }}</span>
                        </div>
                    {% endif %}

                    {% if art.community_board %}
                        <div class="info-item">
                            <span class="info-label">Community Board</span>
                            <span class="info-value">{{ art.community_board }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if art.location %}
                <div class="detail-section">
                    <h2>Location</h2>
                    <p class="detail-location">{{ art.location }}</p>
                    
                    {% if art.latitude and art.longitude %}
                        <div class="coordinates">
                            <small>Coordinates: {{ art.latitude }}, {{ art.longitude }}</small>
                            <a href="https://www.google.com/maps?q={{ art.latitude }},{{ art.longitude }}" 
                               target="_blank" 
                               class="map-link">
                                Open in Google Maps ‚Üí
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Reviews Section -->
            <div class="detail-section comments-section">
                <h2>Reviews & Ratings</h2>
                
                <!-- Rating Summary -->
                {% if total_reviews > 0 %}
                <div class="rating-summary">
                    <div class="rating-score">
                        <div class="rating-number">{{ avg_rating }}</div>
                        <div class="rating-stars">
                            {% load rating_filters %}
                            {{ avg_rating|star_display }}
                        </div>
                        <div class="rating-count">{{ total_reviews }} review{{ total_reviews|pluralize }}</div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Review Form -->
                {% if user_review is None %}
                <div class="review-form-container">
                    <h3>Share Your Experience</h3>
                    <form method="post" class="review-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="star-rating">
                            <input type="radio" name="rating" value="5" id="star5" checked>
                            <label for="star5">‚òÖ</label>
                            <input type="radio" name="rating" value="4" id="star4">
                            <label for="star4">‚òÖ</label>
                            <input type="radio" name="rating" value="3" id="star3">
                            <label for="star3">‚òÖ</label>
                            <input type="radio" name="rating" value="2" id="star2">
                            <label for="star2">‚òÖ</label>
                            <input type="radio" name="rating" value="1" id="star1">
                            <label for="star1">‚òÖ</label>
                        </div>
                        
                        <textarea 
                            name="comment" 
                            rows="4" 
                            placeholder="Share details of your experience at this location..."
                            required
                            class="review-textarea"
                        ></textarea>
                        
                        <div class="image-upload-container">
                            <div style="margin-bottom: 15px;">
                                <p style="font-size: 14px; margin-bottom: 10px;">
                                    Add photos to your review (Max 5 images)
                                </p>
                                
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <label for="images-upload-single" class="btn btn-outline-primary">
                                        üì∑ Add Photo
                                    </label>
                                    <input type="file" id="images-upload-single" accept="image/*" class="image-upload-input">
                                    
                                    <label for="images-upload" class="btn btn-outline-primary">
                                        üìÅ Add Multiple
                                    </label>
                                    <input type="file" id="images-upload" name="images" accept="image/*" multiple class="image-upload-input" data-max="5">
                                </div>

                                <div id="image-size-error" style="display: none; color: #d32f2f; font-size: 14px; margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 4px; border-left: 4px solid #d32f2f;">
                                    <strong>‚ö†Ô∏è Image size error:</strong> <span id="error-message"></span>
                                </div>
                            </div>
                            
                            <div id="drop-area" class="drop-area">
                                <p style="margin: 0; font-size: 14px;">Or drag and drop images here</p>
                            </div>
                            
                            <div class="image-previews" id="image-previews"></div>
                        </div>
                        
                        <button type="submit" class="btn-review">Post Review</button>
                    </form>
                </div>
                {% endif %}

                <!-- Display Reviews -->
                <div class="reviews-list">
                    <h3>Community Reviews ({{ total_reviews }})</h3>
                    {% if comments %}
                        {% for comment in comments %}
                            <div class="review-item" data-comment-id="{{ comment.id }}">
                                <div class="review-header">
                                    <a href="{% url 'user_profile:profile_view' comment.user.username %}">
                                        <div class="review-avatar">{{ comment.user.username|first|upper }}</div>
                                    </a>

                                    <div class="review-author-info">
                                        <div class="review-author">{{ comment.user.username }}</div>
                                        <div class="review-meta">
                                            <span class="review-rating">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= comment.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                                                {% endfor %}
                                            </span>
                                            <span>‚Ä¢</span>
                                            <span>{{ comment.created_at|date:"M d, Y" }}</span>
                                        </div>
                                        <div class="review-badges">
                                            {% if comment.images.count > 0 %}
                                            <span class="review-badge badge-photos">
                                                üì∑ {{ comment.images.count }} Photo{{ comment.images.count|pluralize }}
                                            </span>
                                            {% endif %}
                                            {% if comment.likes_count >= 5 %}
                                            <span class="review-badge badge-helpful">
                                                ‚≠ê Helpful
                                            </span>
                                            {% endif %}
                                            {% if comment.user.art_comments.count >= 10 %}
                                            <span class="review-badge badge-local">
                                                üèôÔ∏è Local Guide
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="review-body">{{ comment.comment }}</div>
                                
                                {% if comment.images.all %}
                                <div class="review-images">
                                    {% for image in comment.images.all %}
                                    <img src="{{ image.image.url }}" alt="Review photo" onclick="openImageModal(this.src)">
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                {% if comment.user == user %}
                                    <button class="btn btn-primary btn-edit-comment" data-comment-id="{{ comment.id }}">Edit</button>

                                    <div class="review-form-container review-edit" hidden>
                                        <h3>Edit Your Review</h3>
                                        <form method="post" class="review-form" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <input type="hidden" name="comment_id" value="{{ user_review.id }}">
                                            
                                            <div class="star-rating" id="edit-star-rating">
                                                <input type="radio" name="rating" value="5" id="edit-star5" {% if user_review.rating == 5 %}checked{% endif %}>
                                                <label for="edit-star5">‚òÖ</label>
                                                <input type="radio" name="rating" value="4" id="edit-star4" {% if user_review.rating == 4 %}checked{% endif %}>
                                                <label for="edit-star4">‚òÖ</label>
                                                <input type="radio" name="rating" value="3" id="edit-star3" {% if user_review.rating == 3 %}checked{% endif %}>
                                                <label for="edit-star3">‚òÖ</label>
                                                <input type="radio" name="rating" value="2" id="edit-star2" {% if user_review.rating == 2 %}checked{% endif %}>
                                                <label for="edit-star2">‚òÖ</label>
                                                <input type="radio" name="rating" value="1" id="edit-star1" {% if user_review.rating == 1 %}checked{% endif %}>
                                                <label for="edit-star1">‚òÖ</label>
                                            </div>
                                            
                                            <textarea 
                                                name="comment" 
                                                rows="4" 
                                                placeholder="Share details of your experience at this location..."
                                                required
                                                class="review-textarea"
                                            >{{ user_review.comment }}</textarea>
                                            
                                            <!-- Existing Images -->
                                            {% if user_review.images.all %}
                                            <div style="margin: 15px 0;">
                                                <p style="font-size: 14px; color: #5f6368; margin-bottom: 10px;">Your uploaded photos:</p>
                                                <div class="existing-images" id="existing-images-{{ user_review.id }}">
                                                    {% for image in user_review.images.all %}
                                                    <div class="existing-image-item" data-image-id="{{ image.id }}">
                                                        <img src="{{ image.image.url }}" alt="Review photo">
                                                        <button type="button" class="delete-image-btn" onclick="deleteExistingImage('{{ image.id }}', '{{ user_review.id }}')">√ó</button>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            {% endif %}
                                                
                                            <div class="image-upload-container">
                                                <div style="margin-bottom: 15px;">
                                                    <p style="font-size: 14px; margin-bottom: 10px;">
                                                        Add more photos (Max 5 total)
                                                    </p>
                                                    
                                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                                        <label for="edit-images-single" class="btn btn-outline-primary">
                                                            üì∑ Add Photo
                                                        </label>
                                                        <input type="file" id="edit-images-single" accept="image/*" class="image-upload-input">
                                                        
                                                        <label for="edit-images-multiple" class="btn btn-outline-primary">
                                                            üìÅ Add Multiple
                                                        </label>
                                                        <input type="file" id="edit-images-multiple" name="images" accept="image/*" multiple class="image-upload-input" data-max="5">
                                                    </div>

                                                    <div id="edit-image-size-error" style="display: none; color: #d32f2f; font-size: 14px; margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 4px; border-left: 4px solid #d32f2f;">
                                                        <strong>‚ö†Ô∏è Image size error:</strong> <span id="edit-error-message"></span>
                                                    </div>

                                                </div>
                                                
                                                <div id="edit-drop-area" class="drop-area">
                                                    <p style="margin: 0; font-size: 14px;">Or drag and drop images here</p>
                                                </div>
                                                
                                                <div class="image-previews" id="edit-image-previews"></div>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary">Update Review</button>
                                        </form>
                                    </div>
                                {% else %}
                                        <div class="review-actions">
                                            <button class="reaction-btn like-btn {% if comment.user_reaction_status == 'like' %}active{% endif %}" 
                                                    data-comment-id="{{ comment.id }}"
                                                    data-reaction="like">
                                                <span class="icon">üëç</span>
                                                <span class="count">{{ comment.likes_count }}</span>
                                            </button>
                                            <button class="reaction-btn dislike-btn {% if comment.user_reaction_status == 'dislike' %}active{% endif %}"
                                                    data-comment-id="{{ comment.id }}"
                                                    data-reaction="dislike">
                                                <span class="icon">üëé</span>
                                                <span class="count">{{ comment.dislikes_count }}</span>
                                            </button>
                                            <button class="reply-btn" data-comment-id="{{ comment.id }}">Reply</button>
                                            <!-- <button class="action-btn share-btn" data-comment-id="{{ comment.id }}">
                                                <span>üîó</span> Share
                                            </button> -->
                                            <button class="action-btn report-btn" data-comment-id="{{ comment.id }}">
                                                <span>‚ö†Ô∏è</span> Report
                                            </button>
                                        </div>
                                {% endif %}
                                
                                <!-- Reply Form -->
                                <div class="reply-form" id="reply-form-{{ comment.id }}">
                                    <form method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                        <textarea 
                                            name="comment" 
                                            placeholder="Write a reply..."
                                            required
                                            class="reply-textarea"
                                        ></textarea>
                                        <div class="reply-actions">
                                            <button type="button" class="btn btn-outline-danger" onclick="cancelReply('{{ comment.id }}')">Cancel</button>
                                            <button type="submit" class="btn btn-primary">Reply</button>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Display Replies -->
                                {% if comment.replies.all %}
                                <div class="replies-container">
                                    {% for reply in comment.replies.all %}
                                    <div class="reply-item" data-comment-id="{{ reply.id }}">
                                        <div class="review-header">
                                            <a href="{% url 'user_profile:profile_view' reply.user.username %}">
                                                <div class="review-avatar">{{ reply.user.username|first|upper }}</div>
                                            </a>
                                            <div class="review-author-info">
                                                <div class="review-author">{{ reply.user.username }}</div>
                                                <div class="review-meta">
                                                    <span>{{ reply.created_at|date:"M d, Y" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="review-body">{{ reply.comment }}</div>
                                        <div class="review-actions">
                                            <button class="reaction-btn like-btn {% if reply.user_reaction_status == 'like' %}active{% endif %}"
                                                    data-comment-id="{{ reply.id }}"
                                                    data-reaction="like">
                                                <span class="icon">üëç</span>
                                                <span class="count">{{ reply.likes_count }}</span>
                                            </button>
                                            <button class="reaction-btn dislike-btn {% if reply.user_reaction_status == 'dislike' %}active{% endif %}"
                                                    data-comment-id="{{ reply.id }}"
                                                    data-reaction="dislike">
                                                <span class="icon">üëé</span>
                                                <span class="count">{{ reply.dislikes_count }}</span>
                                            </button>
                                            <button class="action-btn report-btn" data-comment-id="{{ comment.id }}">
                                                <span>‚ö†Ô∏è</span> Report
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-reviews">
                            <p>No reviews yet. Be the first to share your experience!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="detail-sidebar">
            <div class="sidebar-section">
                <h3>Quick Info</h3>
                <div class="quick-info">
                    {% if art.borough %}
                        <div class="quick-info-item">
                            <span class="quick-label">Borough</span>
                            <span class="quick-value">{{ art.borough }}</span>
                        </div>
                    {% endif %}
                    
                    {% if art.year_created %}
                        <div class="quick-info-item">
                            <span class="quick-label">Created</span>
                            <span class="quick-value">{{ art.year_created }}</span>
                        </div>
                    {% endif %}
                    
                    <div class="quick-info-item">
                        <span class="quick-label">Last Updated</span>
                        <span class="quick-value">{{ art.updated_at|date:"M d, Y" }}</span>
                    </div>
                </div>
            </div>

            {% if related_art %}
                <div class="sidebar-section">
                    <h3>Related Art</h3>
                    <div class="related-art-list">
                        {% for related in related_art %}
                            <a href="{% url 'loc_detail:art_detail' related.id %}" class="related-art-item">
                                <div class="related-art-title">{{ related.title|default:"Untitled"|truncatewords:8 }}</div>
                                <div class="related-art-artist">{{ related.artist_name|default:"Unknown"|truncatewords:4 }}</div>
                                {% if related.borough %}
                                    <div class="related-art-location">{{ related.borough }}</div>
                                {% endif %}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>


<!-- Report Modal -->
<div class="modal-overlay" id="reportModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Report Review</h2>
            <button class="modal-close" onclick="closeReportModal()">√ó</button>
        </div>
        
        <p style="color: #5f6368; margin-bottom: 20px;">Help us understand what's wrong with this review.</p>
        
        <div class="report-reasons" id="reportReasons">
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="spam">
                <div class="reason-label">
                    <div class="reason-title">Spam or misleading</div>
                    <div class="reason-description">Promotional content, fake reviews, or misleading information</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="harassment">
                <div class="reason-label">
                    <div class="reason-title">Harassment or bullying</div>
                    <div class="reason-description">Targeting an individual with unwanted behavior</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="hate">
                <div class="reason-label">
                    <div class="reason-title">Hate speech or discrimination</div>
                    <div class="reason-description">Content promoting hatred based on identity or protected attributes</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="violence">
                <div class="reason-label">
                    <div class="reason-title">Violence or dangerous content</div>
                    <div class="reason-description">Threats, glorification of violence, or dangerous activities</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="sexual">
                <div class="reason-label">
                    <div class="reason-title">Sexual content</div>
                    <div class="reason-description">Inappropriate sexual content or exploitation</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="misinformation">
                <div class="reason-label">
                    <div class="reason-title">False information</div>
                    <div class="reason-description">Deliberately misleading or factually incorrect content</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="copyright">
                <div class="reason-label">
                    <div class="reason-title">Copyright violation</div>
                    <div class="reason-description">Unauthorized use of copyrighted material</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="personal">
                <div class="reason-label">
                    <div class="reason-title">Personal information shared</div>
                    <div class="reason-description">Sharing someone's private information without consent</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="other">
                <div class="reason-label">
                    <div class="reason-title">Other</div>
                    <div class="reason-description">Something else that violates community guidelines</div>
                </div>
            </label>
        </div>
        
        <textarea 
            class="additional-info-textarea" 
            id="additionalInfo" 
            placeholder="Additional details (optional)..."
        ></textarea>
        
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeReportModal()">Cancel</button>
            <button class="btn-submit-report" onclick="submitReport()">Submit Report</button>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal-overlay" id="imageModal" onclick="closeImageModal()">
    <div class="modal-content" style="max-width: 90%; max-height: 90vh; padding: 0; background: transparent;" onclick="event.stopPropagation()">
        <button class="modal-close" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 30px; cursor: pointer; z-index: 10;" onclick="closeImageModal()">√ó</button>
        <img id="modalImage" style="max-width: 100%; max-height: 90vh; object-fit: contain; border-radius: 8px;">
    </div>
</div>

<script src="{% static 'js/locdetail/locdetail.js' %}"></script>
<script>
// Image size validation
(function() {
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB in bytes
    const MAX_FILES = 5;

    function validateImageSize(file) {
        if (!file) {
            return { valid: true, message: '' };
        }
        
        if (file.size > MAX_FILE_SIZE) {
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            const maxSizeMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(0);
            return {
                valid: false,
                message: `One of your files "${file.name}" is ${sizeMB}MB. Maximum allowed size is ${maxSizeMB}MB per image.`
            };
        }
        
        return { valid: true, message: '' };
    }

    function validateMultipleImages(files) {
        const validFiles = [];
        const errors = [];
        
        if (files.length > MAX_FILES) {
            return {
                valid: false,
                message: `You can only upload up to ${MAX_FILES} images. You selected ${files.length} images.`,
                validFiles: []
            };
        }
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const validation = validateImageSize(file);
            
            if (validation.valid) {
                validFiles.push(file);
            } else {
                errors.push(validation.message);
            }
        }
        
        if (errors.length > 0) {
            return {
                valid: false,
                message: errors.join('<br>'),
                validFiles: validFiles
            };
        }
        
        return {
            valid: true,
            message: '',
            validFiles: validFiles
        };
    }

    function showImageError(message, errorDivId, errorMessageId) {
        const errorDiv = document.getElementById(errorDivId);
        const errorMessage = document.getElementById(errorMessageId);
        
        if (errorDiv && errorMessage) {
            errorMessage.innerHTML = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    function hideImageError(errorDivId) {
        const errorDiv = document.getElementById(errorDivId);
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    }

    function attachImageValidation(inputId, errorDivId, errorMessageId) {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        input.addEventListener('change', function(e) {
            hideImageError(errorDivId);
            
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            const validation = validateMultipleImages(files);
            
            if (!validation.valid) {
                showImageError(validation.message, errorDivId, errorMessageId);
                e.target.value = '';
                return;
            }
        });
    }

    function validateFormImages(form, errorDivId, errorMessageId) {
        hideImageError(errorDivId);
        
        const fileInputs = form.querySelectorAll('input[type="file"][name="images"]');
        let allValid = true;
        const allErrors = [];
        
        fileInputs.forEach(input => {
            if (input.files && input.files.length > 0) {
                const validation = validateMultipleImages(input.files);
                if (!validation.valid) {
                    allErrors.push(validation.message);
                    allValid = false;
                }
            }
        });
        
        if (!allValid) {
            showImageError(allErrors.join('<br>'), errorDivId, errorMessageId);
            return false;
        }
        
        return true;
    }

    // Initialize validation when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Attach validation to new review form inputs
        attachImageValidation('images-upload', 'image-size-error', 'error-message');
        attachImageValidation('images-upload-single', 'image-size-error', 'error-message');
        
        // Attach validation to edit review form inputs
        attachImageValidation('edit-images-multiple', 'edit-image-size-error', 'edit-error-message');
        attachImageValidation('edit-images-single', 'edit-image-size-error', 'edit-error-message');
        
        // Validate on form submission for new review
        const reviewForms = document.querySelectorAll('.review-form');
        reviewForms.forEach(form => {
            // Skip edit forms
            if (form.querySelector('#edit-images-multiple')) {
                form.addEventListener('submit', function(e) {
                    if (!validateFormImages(form, 'edit-image-size-error', 'edit-error-message')) {
                        e.preventDefault();
                        return false;
                    }
                });
            } else {
                form.addEventListener('submit', function(e) {
                    if (!validateFormImages(form, 'image-size-error', 'error-message')) {
                        e.preventDefault();
                        return false;
                    }
                });
            }
        });
        
        // Handle drag and drop validation for new review
        const dropArea = document.getElementById('drop-area');
        if (dropArea) {
            dropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                hideImageError('image-size-error');
                
                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    const validation = validateMultipleImages(files);
                    if (!validation.valid) {
                        showImageError(validation.message, 'image-size-error', 'error-message');
                    }
                }
            });
        }
        
        // Handle drag and drop validation for edit review
        const editDropArea = document.getElementById('edit-drop-area');
        if (editDropArea) {
            editDropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                hideImageError('edit-image-size-error');
                
                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    const validation = validateMultipleImages(files);
                    if (!validation.valid) {
                        showImageError(validation.message, 'edit-image-size-error', 'edit-error-message');
                    }
                }
            });
        }
    });
})();
</script>
{% endblock %}