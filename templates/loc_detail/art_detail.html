{% extends 'base.html' %}

{% block title %}{{ art.title|default:"Untitled" }} - Artinerary{% endblock %}

{% block extra_head %}
<style>
    .favorite-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background-color: #fff;
        border: 2px solid #e74c3c;
        color: #e74c3c;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.3s ease;
    }
    .favorite-button:hover {
        background-color: #e74c3c;
        color: white;
    }
    .favorite-button.favorited {
        background-color: #e74c3c;
        color: white;
    }
    .favorite-button .heart {
        font-size: 20px;
    }
    
    /* Rating Summary */
    .rating-summary {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 30px;
    }
    .rating-score {
        text-align: center;
    }
    .rating-number {
        font-size: 48px;
        font-weight: bold;
        color: #333;
    }
    .rating-stars {
        color: #fbbc04;
        font-size: 24px;
    }
    .rating-count {
        color: #666;
        margin-top: 5px;
    }
    
    /* Star Rating Input */
    .star-rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 5px;
        font-size: 32px;
        margin: 15px 0;
    }
    .star-rating input {
        display: none;
    }
    .star-rating label {
        cursor: pointer;
        color: #ddd;
        transition: color 0.2s;
    }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
        color: #fbbc04;
    }
    
    /* Review Form */
    .review-form-container {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    .review-form-container h3 {
        margin-top: 0;
        font-size: 18px;
        font-weight: 600;
    }
    .review-textarea {
        width: 100%;
        min-height: 60px;
        max-height: 300px;
        padding: 12px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        resize: none;
        box-sizing: border-box;
        overflow-y: hidden;
        transition: min-height 0.2s ease;
    }
    .review-textarea:focus {
        outline: none;
        border-color: #4285f4;
        min-height: 100px;
    }
    .btn-review {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 10px;
    }
    .btn-review:hover {
        background: #1557b0;
    }
    
    /* Comments List */
    .reviews-list {
        margin-top: 30px;
    }
    .reviews-list h3 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
    }
    .review-item {
        border-bottom: 1px solid #e0e0e0;
        padding: 20px 0;
    }
    .review-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
    }
    .review-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #4285f4;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 16px;
        flex-shrink: 0;
    }
    .review-author-info {
        flex: 1;
    }
    .review-author {
        font-weight: 600;
        color: #202124;
    }
    .review-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #5f6368;
        margin-top: 2px;
    }
    .review-rating {
        color: #fbbc04;
        font-size: 14px;
    }
    .review-body {
        margin: 12px 0;
        color: #3c4043;
        line-height: 1.6;
    }
    .review-actions {
        display: flex;
        gap: 15px;
        margin-top: 10px;
    }
    .reaction-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #5f6368;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    .reaction-btn:hover {
        background: #f1f3f4;
    }
    .reaction-btn.active {
        color: #1a73e8;
        font-weight: 600;
    }
    .reply-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #1a73e8;
        font-size: 13px;
        font-weight: 600;
        padding: 5px 10px;
    }
    .reply-btn:hover {
        text-decoration: underline;
    }
    
    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #5f6368;
        font-size: 13px;
        padding: 5px 10px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .action-btn:hover {
        color: #1a73e8;
    }
    
    /* Review Badges */
    .review-badges {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
    }
    .review-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .badge-verified {
        background: #e8f5e9;
        color: #2e7d32;
    }
    .badge-local {
        background: #e3f2fd;
        color: #1565c0;
    }
    .badge-helpful {
        background: #fff3e0;
        color: #e65100;
    }
    
    /* Review Image */
    .review-image {
        margin: 12px 0;
        border-radius: 8px;
        overflow: hidden;
        max-width: 400px;
    }
    .review-image img {
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* Image Upload */
    .image-upload-container {
        margin: 15px 0;
    }
    .image-upload-label {
        display: inline-block;
        padding: 8px 16px;
        background: #f1f3f4;
        border: 1px solid #dadce0;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        color: #5f6368;
        transition: background 0.2s;
    }
    .image-upload-label:hover {
        background: #e8eaed;
    }
    .image-upload-input {
        display: none;
    }
    .image-preview {
        margin-top: 10px;
        max-width: 200px;
        border-radius: 4px;
        overflow: hidden;
        display: none;
    }
    .image-preview img {
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* Replies */
    .replies-container {
        margin-left: 52px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #f1f3f4;
    }
    .reply-item {
        padding: 12px 0;
    }
    .reply-form {
        margin-top: 15px;
        margin-left: 52px;
        display: none;
    }
    .reply-form.active {
        display: block;
    }
    .reply-textarea {
        width: 100%;
        min-height: 60px;
        max-height: 200px;
        padding: 10px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 13px;
        font-family: inherit;
        resize: none;
        box-sizing: border-box;
        overflow-y: hidden;
        transition: min-height 0.2s ease;
    }
    .reply-textarea:focus {
        outline: none;
        border-color: #4285f4;
        min-height: 80px;
    }
    .reply-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
    }
    .btn-cancel {
        background: none;
        border: 1px solid #dadce0;
        color: #5f6368;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }
    .btn-cancel:hover {
        background: #f1f3f4;
    }
    
    .no-reviews {
        text-align: center;
        padding: 40px 20px;
        color: #5f6368;
    }
</style>
{% endblock %}

{% block content %}
<div class="art-detail-container">
    <div class="breadcrumb">
        <a href="{% url 'loc_detail:index' %}">‚Üê Back to Gallery</a>
    </div>

    <div class="detail-grid">
        <div class="detail-main">
            <div class="detail-header">
                <h1 class="detail-title">{{ art.title|default:"Untitled" }}</h1>
                {% if art.borough %}
                    <span class="detail-badge">{{ art.borough }}</span>
                {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button 
                    id="favorite-button" 
                    class="favorite-button {% if is_favorited %}favorited{% endif %}"
                    data-art-id="{{ art.id }}"
                    data-favorited="{{ is_favorited|yesno:'true,false' }}"
                >
                    <span class="heart">&#10084;</span>
                    <span id="favorite-text">{% if is_favorited %}Remove from Favorites{% else %}Add to Favorites{% endif %}</span>
                </button>

                <button 
                    id="add-to-itinerary-button" 
                    class="favorite-button"
                    data-art-id="{{ art.id }}"
                    data-art-title="{{ art.title|default:'Untitled' }}"
                    style="border-color: #3498db; color: #3498db;"
                >
                    <span style="font-size: 20px;">üìç</span>
                    <span>Add to Itinerary</span>
                </button>
            </div>

            <div class="detail-section">
                <h2>Artist Information</h2>
                <p class="detail-artist">{{ art.artist_name|default:"Unknown Artist" }}</p>
            </div>

            {% if art.description %}
                <div class="detail-section">
                    <h2>Description</h2>
                    <p class="detail-description">{{ art.description }}</p>
                </div>
            {% endif %}

            <div class="detail-section">
                <h2>Details</h2>
                <div class="detail-info-grid">
                    {% if art.medium %}
                        <div class="info-item">
                            <span class="info-label">Medium</span>
                            <span class="info-value">{{ art.medium }}</span>
                        </div>
                    {% endif %}

                    {% if art.dimensions %}
                        <div class="info-item">
                            <span class="info-label">Dimensions</span>
                            <span class="info-value">{{ art.dimensions }}</span>
                        </div>
                    {% endif %}

                    {% if art.year_created %}
                        <div class="info-item">
                            <span class="info-label">Year Created</span>
                            <span class="info-value">{{ art.year_created }}</span>
                        </div>
                    {% endif %}

                    {% if art.year_dedicated %}
                        <div class="info-item">
                            <span class="info-label">Year Dedicated</span>
                            <span class="info-value">{{ art.year_dedicated }}</span>
                        </div>
                    {% endif %}

                    {% if art.agency %}
                        <div class="info-item">
                            <span class="info-label">Agency</span>
                            <span class="info-value">{{ art.agency }}</span>
                        </div>
                    {% endif %}

                    {% if art.community_board %}
                        <div class="info-item">
                            <span class="info-label">Community Board</span>
                            <span class="info-value">{{ art.community_board }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if art.location %}
                <div class="detail-section">
                    <h2>Location</h2>
                    <p class="detail-location">{{ art.location }}</p>
                    
                    {% if art.latitude and art.longitude %}
                        <div class="coordinates">
                            <small>Coordinates: {{ art.latitude }}, {{ art.longitude }}</small>
                            <a href="https://www.google.com/maps?q={{ art.latitude }},{{ art.longitude }}" 
                               target="_blank" 
                               class="map-link">
                                Open in Google Maps ‚Üí
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Reviews Section -->
            <div class="detail-section comments-section">
                <h2>Reviews & Ratings</h2>
                
                <!-- Rating Summary -->
                {% if total_reviews > 0 %}
                <div class="rating-summary">
                    <div class="rating-score">
                        <div class="rating-number">{{ avg_rating }}</div>
                        <div class="rating-stars">
                            {% with avg_rating|floatformat:0 as rating_int %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= rating_int|add:0 %}‚òÖ{% else %}‚òÜ{% endif %}
                            {% endfor %}
                            {% endwith %}
                        </div>
                        <div class="rating-count">{{ total_reviews }} review{{ total_reviews|pluralize }}</div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Review Form -->
                {% if user_review %}
                <div class="review-form-container">
                    <h3>Edit Your Review</h3>
                    <form method="post" class="review-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="comment_id" value="{{ user_review.id }}">
                        
                        <div class="star-rating" id="edit-star-rating">
                            <input type="radio" name="rating" value="5" id="edit-star5" {% if user_review.rating == 5 %}checked{% endif %}>
                            <label for="edit-star5">‚òÖ</label>
                            <input type="radio" name="rating" value="4" id="edit-star4" {% if user_review.rating == 4 %}checked{% endif %}>
                            <label for="edit-star4">‚òÖ</label>
                            <input type="radio" name="rating" value="3" id="edit-star3" {% if user_review.rating == 3 %}checked{% endif %}>
                            <label for="edit-star3">‚òÖ</label>
                            <input type="radio" name="rating" value="2" id="edit-star2" {% if user_review.rating == 2 %}checked{% endif %}>
                            <label for="edit-star2">‚òÖ</label>
                            <input type="radio" name="rating" value="1" id="edit-star1" {% if user_review.rating == 1 %}checked{% endif %}>
                            <label for="edit-star1">‚òÖ</label>
                        </div>
                        
                        <textarea 
                            name="comment" 
                            rows="4" 
                            placeholder="Share details of your experience at this location..."
                            required
                            class="review-textarea"
                        >{{ user_review.comment }}</textarea>
                        
                        <div class="image-upload-container">
                            <label for="edit-image-upload" class="image-upload-label">
                                üì∑ Add or Change Photo
                            </label>
                            <input type="file" id="edit-image-upload" name="image" accept="image/*" class="image-upload-input">
                            <div class="image-preview" id="edit-image-preview">
                                {% if user_review.image %}
                                <img src="{{ user_review.image.url }}" alt="Review image">
                                {% endif %}
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-review">Update Review</button>
                    </form>
                </div>
                {% else %}
                <div class="review-form-container">
                    <h3>Share Your Experience</h3>
                    <form method="post" class="review-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="star-rating">
                            <input type="radio" name="rating" value="5" id="star5" checked>
                            <label for="star5">‚òÖ</label>
                            <input type="radio" name="rating" value="4" id="star4">
                            <label for="star4">‚òÖ</label>
                            <input type="radio" name="rating" value="3" id="star3">
                            <label for="star3">‚òÖ</label>
                            <input type="radio" name="rating" value="2" id="star2">
                            <label for="star2">‚òÖ</label>
                            <input type="radio" name="rating" value="1" id="star1">
                            <label for="star1">‚òÖ</label>
                        </div>
                        
                        <textarea 
                            name="comment" 
                            rows="4" 
                            placeholder="Share details of your experience at this location..."
                            required
                            class="review-textarea"
                        ></textarea>
                        
                        <div class="image-upload-container">
                            <label for="image-upload" class="image-upload-label">
                                üì∑ Add Photo
                            </label>
                            <input type="file" id="image-upload" name="image" accept="image/*" class="image-upload-input">
                            <div class="image-preview" id="image-preview"></div>
                        </div>
                        
                        <button type="submit" class="btn-review">Post Review</button>
                    </form>
                </div>
                {% endif %}

                <!-- Display Reviews -->
                <div class="reviews-list">
                    <h3>Community Reviews ({{ total_reviews }})</h3>
                    {% if comments %}
                        {% for comment in comments %}
                            <div class="review-item" data-comment-id="{{ comment.id }}">
                                <div class="review-header">
                                    <div class="review-avatar">{{ comment.user.username|first|upper }}</div>
                                    <div class="review-author-info">
                                        <div class="review-author">{{ comment.user.username }}</div>
                                        <div class="review-meta">
                                            <span class="review-rating">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= comment.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                                                {% endfor %}
                                            </span>
                                            <span>‚Ä¢</span>
                                            <span>{{ comment.created_at|date:"M d, Y" }}</span>
                                        </div>
                                        <div class="review-badges">
                                            {% if comment.likes_count >= 5 %}
                                            <span class="review-badge badge-helpful">
                                                ‚≠ê Helpful
                                            </span>
                                            {% endif %}
                                            {% if comment.user.art_comments.count >= 10 %}
                                            <span class="review-badge badge-local">
                                                üèôÔ∏è Local Guide
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="review-body">{{ comment.comment }}</div>
                                
                                {% if comment.image %}
                                <div class="review-image">
                                    <img src="{{ comment.image.url }}" alt="Review photo">
                                </div>
                                {% endif %}
                                
                                <div class="review-actions">
                                    <button class="reaction-btn like-btn {% if comment.user_reaction_status == 'like' %}active{% endif %}" 
                                            data-comment-id="{{ comment.id }}"
                                            data-reaction="like">
                                        <span class="icon">üëç</span>
                                        <span class="count">{{ comment.likes_count }}</span>
                                    </button>
                                    <button class="reaction-btn dislike-btn {% if comment.user_reaction_status == 'dislike' %}active{% endif %}"
                                            data-comment-id="{{ comment.id }}"
                                            data-reaction="dislike">
                                        <span class="icon">üëé</span>
                                        <span class="count">{{ comment.dislikes_count }}</span>
                                    </button>
                                    <button class="reply-btn" data-comment-id="{{ comment.id }}">Reply</button>
                                    <button class="action-btn share-btn" data-comment-id="{{ comment.id }}">
                                        <span>üîó</span> Share
                                    </button>
                                    <button class="action-btn report-btn" data-comment-id="{{ comment.id }}">
                                        <span>‚ö†Ô∏è</span> Report
                                    </button>
                                </div>
                                
                                <!-- Reply Form (hidden by default) -->
                                <div class="reply-form" id="reply-form-{{ comment.id }}">
                                    <form method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                        <textarea 
                                            name="comment" 
                                            placeholder="Write a reply..."
                                            required
                                            class="reply-textarea"
                                        ></textarea>
                                        <div class="reply-actions">
                                            <button type="button" class="btn-cancel" onclick="cancelReply('{{ comment.id }}')">Cancel</button>
                                            <button type="submit" class="btn-review">Reply</button>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Display Replies -->
                                {% if comment.replies.all %}
                                <div class="replies-container">
                                    {% for reply in comment.replies.all %}
                                    <div class="reply-item" data-comment-id="{{ reply.id }}">
                                        <div class="review-header">
                                            <div class="review-avatar">{{ reply.user.username|first|upper }}</div>
                                            <div class="review-author-info">
                                                <div class="review-author">{{ reply.user.username }}</div>
                                                <div class="review-meta">
                                                    <span>{{ reply.created_at|date:"M d, Y" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="review-body">{{ reply.comment }}</div>
                                        <div class="review-actions">
                                            <button class="reaction-btn like-btn {% if reply.user_reaction_status == 'like' %}active{% endif %}"
                                                    data-comment-id="{{ reply.id }}"
                                                    data-reaction="like">
                                                <span class="icon">üëç</span>
                                                <span class="count">{{ reply.likes_count }}</span>
                                            </button>
                                            <button class="reaction-btn dislike-btn {% if reply.user_reaction_status == 'dislike' %}active{% endif %}"
                                                    data-comment-id="{{ reply.id }}"
                                                    data-reaction="dislike">
                                                <span class="icon">üëé</span>
                                                <span class="count">{{ reply.dislikes_count }}</span>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-reviews">
                            <p>No reviews yet. Be the first to share your experience!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="detail-sidebar">
            <div class="sidebar-section">
                <h3>Quick Info</h3>
                <div class="quick-info">
                    {% if art.borough %}
                        <div class="quick-info-item">
                            <span class="quick-label">Borough</span>
                            <span class="quick-value">{{ art.borough }}</span>
                        </div>
                    {% endif %}
                    
                    {% if art.year_created %}
                        <div class="quick-info-item">
                            <span class="quick-label">Created</span>
                            <span class="quick-value">{{ art.year_created }}</span>
                        </div>
                    {% endif %}
                    
                    <div class="quick-info-item">
                        <span class="quick-label">Last Updated</span>
                        <span class="quick-value">{{ art.updated_at|date:"M d, Y" }}</span>
                    </div>
                </div>
            </div>

            {% if related_art %}
                <div class="sidebar-section">
                    <h3>Related Art</h3>
                    <div class="related-art-list">
                        {% for related in related_art %}
                            <a href="{% url 'loc_detail:art_detail' related.id %}" class="related-art-item">
                                <div class="related-art-title">{{ related.title|default:"Untitled"|truncatewords:8 }}</div>
                                <div class="related-art-artist">{{ related.artist_name|default:"Unknown"|truncatewords:4 }}</div>
                                {% if related.borough %}
                                    <div class="related-art-location">{{ related.borough }}</div>
                                {% endif %}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // CSRF token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Favorite button functionality
    document.addEventListener('DOMContentLoaded', function() {
        const favoriteBtn = document.getElementById('favorite-button');
        const favoriteText = document.getElementById('favorite-text');
        
        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', function() {
                const artId = this.getAttribute('data-art-id');
                const isFavorited = this.getAttribute('data-favorited') === 'true';
                
                fetch(`/loc_detail/api/favorite/${artId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.favorited) {
                        favoriteBtn.classList.add('favorited');
                        favoriteText.textContent = 'Remove from Favorites';
                        favoriteBtn.setAttribute('data-favorited', 'true');
                        alert('Location added to favourites');
                    } else {
                        favoriteBtn.classList.remove('favorited');
                        favoriteText.textContent = 'Add to Favorites';
                        favoriteBtn.setAttribute('data-favorited', 'false');
                        alert('Location removed from favourites');
                    }
                })
                .catch(error => {
                    console.error('Error toggling favorite:', error);
                    alert('Failed to update favorites. Please try again.');
                });
            });
        }
        
        // Star rating functionality
        const starRating = document.querySelector('.star-rating');
        if (starRating) {
            const inputs = starRating.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    // Visual feedback handled by CSS
                });
            });
        }
        
        // Edit star rating functionality
        const editStarRating = document.getElementById('edit-star-rating');
        if (editStarRating) {
            const inputs = editStarRating.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    // Visual feedback handled by CSS
                });
            });
        }
        
        // Reply button functionality
        const replyBtns = document.querySelectorAll('.reply-btn');
        replyBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                const replyForm = document.getElementById(`reply-form-${commentId}`);
                if (replyForm) {
                    replyForm.classList.toggle('active');
                }
            });
        });
        
        // Like/Dislike functionality with proper toggle
        const reactionBtns = document.querySelectorAll('.reaction-btn');
        reactionBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                const reaction = this.getAttribute('data-reaction');
                const commentItem = this.closest('[data-comment-id="' + commentId + '"]');
                const likeBtn = commentItem.querySelector('.like-btn');
                const dislikeBtn = commentItem.querySelector('.dislike-btn');
                const likeBtnCount = likeBtn.querySelector('.count');
                const dislikeBtnCount = dislikeBtn.querySelector('.count');
                
                // Check current state
                const isLikeActive = likeBtn.classList.contains('active');
                const isDislikeActive = dislikeBtn.classList.contains('active');
                
                fetch(`/loc_detail/api/comment/${commentId}/reaction`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken
                    },
                    body: `reaction=${reaction}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update counts
                        likeBtnCount.textContent = data.likes;
                        dislikeBtnCount.textContent = data.dislikes;
                        
                        // Update active states based on action
                        if (reaction === 'like') {
                            if (data.action === 'removed') {
                                // Like was removed
                                likeBtn.classList.remove('active');
                            } else {
                                // Like was added or changed from dislike
                                likeBtn.classList.add('active');
                                dislikeBtn.classList.remove('active');
                            }
                        } else {
                            if (data.action === 'removed') {
                                // Dislike was removed
                                dislikeBtn.classList.remove('active');
                            } else {
                                // Dislike was added or changed from like
                                dislikeBtn.classList.add('active');
                                likeBtn.classList.remove('active');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
        
        // Image upload preview
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const editImageUpload = document.getElementById('edit-image-upload');
        const editImagePreview = document.getElementById('edit-image-preview');
        
        if (imageUpload) {
            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.innerHTML = '<img src="' + e.target.result + '" alt="Preview">';
                        imagePreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
        
        if (editImageUpload) {
            editImageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        editImagePreview.innerHTML = '<img src="' + e.target.result + '" alt="Preview">';
                        editImagePreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Share button functionality (placeholder)
        const shareBtns = document.querySelectorAll('.share-btn');
        shareBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                alert('Share functionality will be implemented soon!');
            });
        });
        
        // Report button functionality (placeholder)
        const reportBtns = document.querySelectorAll('.report-btn');
        reportBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                if (confirm('Report this review for violating community guidelines?')) {
                    alert('Report functionality will be implemented soon. Thank you for helping keep our community safe!');
                }
            });
        });
        
        // Auto-expanding textarea functionality
        function autoExpandTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, parseInt(getComputedStyle(textarea).maxHeight)) + 'px';
        }
        
        // Apply to all textareas
        const textareas = document.querySelectorAll('.review-textarea, .reply-textarea');
        textareas.forEach(textarea => {
            // Auto-expand on input
            textarea.addEventListener('input', function() {
                autoExpandTextarea(this);
            });
            
            // Auto-expand on focus
            textarea.addEventListener('focus', function() {
                autoExpandTextarea(this);
            });
            
            // Reset on blur if empty
            textarea.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    this.style.height = '';
                }
            });
        });
    });
    
    function cancelReply(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
            replyForm.classList.remove('active');
        }
    }
    
    // Add to Itinerary functionality
    const addToItineraryBtn = document.getElementById('add-to-itinerary-button');
    if (addToItineraryBtn) {
        addToItineraryBtn.addEventListener('click', function() {
            const artId = this.getAttribute('data-art-id');
            const artTitle = this.getAttribute('data-art-title');
            showAddToItineraryModal(artId, artTitle);
        });
    }
    
    function showAddToItineraryModal(locationId, locationTitle) {
        // Create modal HTML
        const modalHTML = `
            <div id="itinerary-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
                    <h3 style="margin-top: 0;">Add "${locationTitle}" to Itinerary</h3>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold;">Select an existing itinerary:</label>
                        <select id="existing-itinerary" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div style="text-align: center; margin: 15px 0; color: #666;">OR</div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold;">Create a new itinerary:</label>
                        <input type="text" id="new-itinerary-title" placeholder="Enter itinerary name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="closeItineraryModal()" style="flex: 1; padding: 10px; background: #ddd; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Cancel</button>
                        <button onclick="submitAddToItinerary('${locationId}')" style="flex: 1; padding: 10px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Add</button>
                    </div>
                    <div id="itinerary-message" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('itinerary-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Load user's itineraries
        fetch('/itineraries/api/user-itineraries/')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('existing-itinerary');
                if (data.itineraries && data.itineraries.length > 0) {
                    select.innerHTML = '<option value="">-- Select an itinerary --</option>' +
                        data.itineraries.map(itin => 
                            `<option value="${itin.id}">${itin.title} (${itin.stop_count} stops)</option>`
                        ).join('');
                } else {
                    select.innerHTML = '<option value="">No itineraries yet</option>';
                }
            })
            .catch(error => {
                console.error('Error loading itineraries:', error);
                const select = document.getElementById('existing-itinerary');
                select.innerHTML = '<option value="">Error loading itineraries</option>';
            });
    }
    
    window.closeItineraryModal = function() {
        const modal = document.getElementById('itinerary-modal');
        if (modal) {
            modal.remove();
        }
    };
    
    window.submitAddToItinerary = function(locationId) {
        const existingItineraryId = document.getElementById('existing-itinerary').value;
        const newItineraryTitle = document.getElementById('new-itinerary-title').value.trim();
        const messageDiv = document.getElementById('itinerary-message');
        
        // Validate input
        if (!existingItineraryId && !newItineraryTitle) {
            messageDiv.textContent = 'Please select an existing itinerary or create a new one';
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#fee';
            messageDiv.style.color = '#c00';
            return;
        }
        
        // Prepare form data
        const formData = new FormData();
        formData.append('location_id', locationId);
        if (newItineraryTitle) {
            formData.append('new_itinerary_title', newItineraryTitle);
        } else {
            formData.append('itinerary_id', existingItineraryId);
        }
        
        // Submit request
        fetch('/itineraries/api/add-to-itinerary/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.textContent = data.message;
                messageDiv.style.display = 'block';
                messageDiv.style.background = '#efe';
                messageDiv.style.color = '#060';
                
                // Close modal after 1.5 seconds
                setTimeout(() => {
                    closeItineraryModal();
                }, 1500);
            } else {
                messageDiv.textContent = data.error || 'Failed to add to itinerary';
                messageDiv.style.display = 'block';
                messageDiv.style.background = '#fee';
                messageDiv.style.color = '#c00';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            messageDiv.textContent = 'An error occurred. Please try again.';
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#fee';
            messageDiv.style.color = '#c00';
        });
    };
</script>
{% endblock %}