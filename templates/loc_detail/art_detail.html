{% extends 'base.html' %}

{% block title %}{{ art.title|default:"Untitled" }} - Artinerary{% endblock %}

{% block extra_head %}
<style>
    .favorite-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background-color: #fff;
        border: 2px solid #e74c3c;
        color: #e74c3c;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.3s ease;
    }
    .favorite-button:hover {
        background-color: #e74c3c;
        color: white;
    }
    .favorite-button.favorited {
        background-color: #e74c3c;
        color: white;
    }
    .favorite-button .heart {
        font-size: 20px;
    }
    
    /* Rating Summary */
    .rating-summary {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 30px;
    }
    .rating-score {
        text-align: center;
    }
    .rating-number {
        font-size: 48px;
        font-weight: bold;
        color: #333;
    }
    .rating-stars {
        color: #fbbc04;
        font-size: 24px;
    }
    .rating-count {
        color: #666;
        margin-top: 5px;
    }
    
    /* Star Rating Input */
    .star-rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 5px;
        font-size: 32px;
        margin: 15px 0;
    }
    .star-rating input {
        display: none;
    }
    .star-rating label {
        cursor: pointer;
        color: #ddd;
        transition: color 0.2s;
    }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
        color: #fbbc04;
    }
    
    /* Review Form */
    .review-form-container {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    .review-form-container h3 {
        margin-top: 0;
        font-size: 18px;
        font-weight: 600;
    }
    .review-textarea {
        width: 100%;
        min-height: 60px;
        max-height: 300px;
        padding: 12px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        resize: none;
        box-sizing: border-box;
        overflow-y: hidden;
        transition: min-height 0.2s ease;
    }
    .review-textarea:focus {
        outline: none;
        border-color: #4285f4;
        min-height: 100px;
    }
    .btn-review {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 10px;
    }
    .btn-review:hover {
        background: #1557b0;
    }
    
    /* Comments List */
    .reviews-list {
        margin-top: 30px;
    }
    .reviews-list h3 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
    }
    .review-item {
        border-bottom: 1px solid #e0e0e0;
        padding: 20px 0;
    }
    .review-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
    }
    .review-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #4285f4;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 16px;
        flex-shrink: 0;
    }
    .review-author-info {
        flex: 1;
    }
    .review-author {
        font-weight: 600;
        color: #202124;
    }
    .review-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #5f6368;
        margin-top: 2px;
    }
    .review-rating {
        color: #fbbc04;
        font-size: 14px;
    }
    .review-body {
        margin: 12px 0;
        color: #3c4043;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .review-actions {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    .reaction-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #5f6368;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    .reaction-btn:hover:not(:disabled) {
        background: #f1f3f4;
    }
    .reaction-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    .reaction-btn.active {
        color: #1a73e8;
        font-weight: 600;
    }
    .reply-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #1a73e8;
        font-size: 13px;
        font-weight: 600;
        padding: 5px 10px;
    }
    .reply-btn:hover {
        text-decoration: underline;
    }
    
    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #5f6368;
        font-size: 13px;
        padding: 5px 10px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .action-btn:hover {
        color: #1a73e8;
    }
    
    /* Review Badges */
    .review-badges {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
    }
    .review-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .badge-verified {
        background: #e8f5e9;
        color: #2e7d32;
    }
    .badge-local {
        background: #e3f2fd;
        color: #1565c0;
    }
    .badge-helpful {
        background: #fff3e0;
        color: #e65100;
    }
    .badge-photos {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    
    
    /* Review Images - Multiple */
    .review-images {
        margin: 12px 0;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        max-width: 600px;
    }
    .review-images img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .review-images img:hover {
        transform: scale(1.05);
    }
    
    /* Image Upload */
    .image-upload-container {
        margin: 15px 0;
    }
    
    .image-upload-label {
        display: inline-block;
        padding: 8px 16px;
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: background 0.2s;
        margin-right: 10px;
    }
    
    .image-upload-label:hover {
        background: #1557b0;
    }
    
    .image-upload-input {
        display: none;
    }
    
    .drop-area {
        border: 2px dashed #dadce0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background: #f8f9fa;
        margin: 15px 0;
        transition: all 0.3s;
    }
    
    .drop-area.highlight {
        border-color: #1a73e8;
        background: #e3f2fd;
    }
    
    .image-previews {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        max-width: 600px;
        margin-top: 15px;
    }
    
    .image-preview-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #e0e0e0;
    }
    
    .image-preview-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        display: block;
    }
    
    .remove-image-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(234, 67, 53, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .remove-image-btn:hover {
        background: rgba(197, 34, 31, 1);
        transform: scale(1.1);
    }

    /* Existing Images Display */
    .existing-images {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        max-width: 600px;
    }
    
    .existing-image-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #e0e0e0;
    }
    
    .existing-image-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        display: block;
    }
    
    .delete-image-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(234, 67, 53, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        font-size: 20px;
        line-height: 1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .delete-image-btn:hover {
        background: rgba(197, 34, 31, 1);
        transform: scale(1.1);
    }
    
    /* Report Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    .modal-overlay.active {
        display: flex;
    }
    .modal-content {
        background: white;
        border-radius: 8px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #202124;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #5f6368;
    }
    .report-reasons {
        margin: 20px 0;
    }
    .reason-option {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .reason-option:hover {
        background: #f8f9fa;
    }
    .reason-option input[type="checkbox"] {
        margin-top: 2px;
    }
    .reason-label {
        flex: 1;
    }
    .reason-title {
        font-weight: 500;
        color: #202124;
        margin-bottom: 4px;
    }
    .reason-description {
        font-size: 12px;
        color: #5f6368;
    }
    .additional-info-textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-family: inherit;
        resize: vertical;
        margin-top: 10px;
    }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    .btn-cancel {
        background: none;
        border: 1px solid #dadce0;
        color: #5f6368;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }
    .btn-cancel:hover {
        background: #f1f3f4;
    }
    .btn-submit-report {
        background: #ea4335;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }
    .btn-submit-report:hover {
        background: #d33828;
    }
    .btn-submit-report:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    /* Replies */
    .replies-container {
        margin-left: 52px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #f1f3f4;
    }
    .reply-item {
        padding: 12px 0;
    }
    .reply-form {
        margin-top: 15px;
        margin-left: 52px;
        display: none;
    }
    .reply-form.active {
        display: block;
    }
    .reply-textarea {
        width: 100%;
        min-height: 60px;
        max-height: 200px;
        padding: 10px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 13px;
        font-family: inherit;
        resize: none;
        box-sizing: border-box;
        overflow-y: hidden;
        transition: min-height 0.2s ease;
    }
    .reply-textarea:focus {
        outline: none;
        border-color: #4285f4;
        min-height: 80px;
    }
    .reply-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
    }
    
    .no-reviews {
        text-align: center;
        padding: 40px 20px;
        color: #5f6368;
    }
    
    /* Detail Image */
    .detail-image {
        width: 100%;
        max-height: 500px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .detail-image.placeholder {
        width: 100%;
        height: 300px;
        background: #f1f3f4;
        border: 2px dashed #dadce0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #5f6368;
        font-size: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="art-detail-container">
    <div class="breadcrumb">
        <a href="{% url 'loc_detail:index' %}">‚Üê Back to Gallery</a>
    </div>

    <div class="detail-grid">
        <div class="detail-main">
            <div class="detail-header">
                <h1 class="detail-title">{{ art.title|default:"Untitled" }}</h1>
                {% if art.borough %}
                    <span class="detail-badge">{{ art.borough }}</span>
                {% endif %}
            </div>

            {% if art.image %}
                <div class="detail-image">
                    {{ art.art_image|safe }}
                </div>
            {% else %}
                <div class="detail-image placeholder">
                    <p>No image available</p>
                </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="action-buttons" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button 
                    id="favorite-button" 
                    class="favorite-button {% if is_favorited %}favorited{% endif %}"
                    data-art-id="{{ art.id }}"
                    data-favorited="{{ is_favorited|yesno:'true,false' }}"
                >
                    <span class="heart">&#10084;</span>
                    <span id="favorite-text">{% if is_favorited %}Remove from Favorites{% else %}Add to Favorites{% endif %}</span>
                </button>

                <button 
                    id="add-to-itinerary-button" 
                    class="favorite-button"
                    data-art-id="{{ art.id }}"
                    data-art-title="{{ art.title|default:'Untitled' }}"
                    style="border-color: #3498db; color: #3498db;"
                >
                    <span style="font-size: 20px;">üìç</span>
                    <span>Add to Itinerary</span>
                </button>
            </div>

            <div class="detail-section">
                <h2>Artist Information</h2>
                <p class="detail-artist">{{ art.artist_name|default:"Unknown Artist" }}</p>
            </div>

            {% if art.description %}
                <div class="detail-section">
                    <h2>Description</h2>
                    <p class="detail-description">{{ art.description }}</p>
                </div>
            {% endif %}

            <div class="detail-section">
                <h2>Details</h2>
                <div class="detail-info-grid">
                    {% if art.medium %}
                        <div class="info-item">
                            <span class="info-label">Medium</span>
                            <span class="info-value">{{ art.medium }}</span>
                        </div>
                    {% endif %}

                    {% if art.dimensions %}
                        <div class="info-item">
                            <span class="info-label">Dimensions</span>
                            <span class="info-value">{{ art.dimensions }}</span>
                        </div>
                    {% endif %}

                    {% if art.year_created %}
                        <div class="info-item">
                            <span class="info-label">Year Created</span>
                            <span class="info-value">{{ art.year_created }}</span>
                        </div>
                    {% endif %}

                    {% if art.year_dedicated %}
                        <div class="info-item">
                            <span class="info-label">Year Dedicated</span>
                            <span class="info-value">{{ art.year_dedicated }}</span>
                        </div>
                    {% endif %}

                    {% if art.agency %}
                        <div class="info-item">
                            <span class="info-label">Agency</span>
                            <span class="info-value">{{ art.agency }}</span>
                        </div>
                    {% endif %}

                    {% if art.community_board %}
                        <div class="info-item">
                            <span class="info-label">Community Board</span>
                            <span class="info-value">{{ art.community_board }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if art.location %}
                <div class="detail-section">
                    <h2>Location</h2>
                    <p class="detail-location">{{ art.location }}</p>
                    
                    {% if art.latitude and art.longitude %}
                        <div class="coordinates">
                            <small>Coordinates: {{ art.latitude }}, {{ art.longitude }}</small>
                            <a href="https://www.google.com/maps?q={{ art.latitude }},{{ art.longitude }}" 
                               target="_blank" 
                               class="map-link">
                                Open in Google Maps ‚Üí
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Reviews Section -->
            <div class="detail-section comments-section">
                <h2>Reviews & Ratings</h2>
                
                <!-- Rating Summary -->
                {% if total_reviews > 0 %}
                <div class="rating-summary">
                    <div class="rating-score">
                        <div class="rating-number">{{ avg_rating }}</div>
                        <div class="rating-stars">
                            {% with avg_rating|floatformat:0 as rating_int %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= rating_int|add:0 %}‚òÖ{% else %}‚òÜ{% endif %}
                            {% endfor %}
                            {% endwith %}
                        </div>
                        <div class="rating-count">{{ total_reviews }} review{{ total_reviews|pluralize }}</div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Review Form -->
                {% if user_review %}
                <div class="review-form-container">
                    <h3>Edit Your Review</h3>
                    <form method="post" class="review-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="comment_id" value="{{ user_review.id }}">
                        
                        <div class="star-rating" id="edit-star-rating">
                            <input type="radio" name="rating" value="5" id="edit-star5" {% if user_review.rating == 5 %}checked{% endif %}>
                            <label for="edit-star5">‚òÖ</label>
                            <input type="radio" name="rating" value="4" id="edit-star4" {% if user_review.rating == 4 %}checked{% endif %}>
                            <label for="edit-star4">‚òÖ</label>
                            <input type="radio" name="rating" value="3" id="edit-star3" {% if user_review.rating == 3 %}checked{% endif %}>
                            <label for="edit-star3">‚òÖ</label>
                            <input type="radio" name="rating" value="2" id="edit-star2" {% if user_review.rating == 2 %}checked{% endif %}>
                            <label for="edit-star2">‚òÖ</label>
                            <input type="radio" name="rating" value="1" id="edit-star1" {% if user_review.rating == 1 %}checked{% endif %}>
                            <label for="edit-star1">‚òÖ</label>
                        </div>
                        
                        <textarea 
                            name="comment" 
                            rows="4" 
                            placeholder="Share details of your experience at this location..."
                            required
                            class="review-textarea"
                        >{{ user_review.comment }}</textarea>
                        
                        <!-- Existing Images -->
                        {% if user_review.images.all %}
                        <div style="margin: 15px 0;">
                            <p style="font-size: 14px; color: #5f6368; margin-bottom: 10px;">Your uploaded photos:</p>
                            <div class="existing-images" id="existing-images-{{ user_review.id }}">
                                {% for image in user_review.images.all %}
                                <div class="existing-image-item" data-image-id="{{ image.id }}">
                                    <img src="{{ image.image.url }}" alt="Review photo">
                                    <button type="button" class="delete-image-btn" onclick="deleteExistingImage('{{ image.id }}', '{{ user_review.id }}')">√ó</button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="image-upload-container">
                            <div style="margin-bottom: 15px;">
                                <p style="font-size: 14px; color: #5f6368; margin-bottom: 10px;">
                                    Add more photos (Max 5 total)
                                </p>
                                
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <label for="edit-images-single" class="image-upload-label">
                                        üì∑ Add Photo
                                    </label>
                                    <input type="file" id="edit-images-single" accept="image/*" class="image-upload-input">
                                    
                                    <label for="edit-images-multiple" class="image-upload-label">
                                        üìÅ Add Multiple
                                    </label>
                                    <input type="file" id="edit-images-multiple" name="images" accept="image/*" multiple class="image-upload-input" data-max="5">
                                </div>
                            </div>
                            
                            <div id="edit-drop-area" class="drop-area">
                                <p style="margin: 0; color: #5f6368; font-size: 14px;">Or drag and drop images here</p>
                            </div>
                            
                            <div class="image-previews" id="edit-image-previews"></div>
                        </div>
                        
                        <button type="submit" class="btn-review">Update Review</button>
                    </form>
                </div>
                {% else %}
                <div class="review-form-container">
                    <h3>Share Your Experience</h3>
                    <form method="post" class="review-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="star-rating">
                            <input type="radio" name="rating" value="5" id="star5" checked>
                            <label for="star5">‚òÖ</label>
                            <input type="radio" name="rating" value="4" id="star4">
                            <label for="star4">‚òÖ</label>
                            <input type="radio" name="rating" value="3" id="star3">
                            <label for="star3">‚òÖ</label>
                            <input type="radio" name="rating" value="2" id="star2">
                            <label for="star2">‚òÖ</label>
                            <input type="radio" name="rating" value="1" id="star1">
                            <label for="star1">‚òÖ</label>
                        </div>
                        
                        <textarea 
                            name="comment" 
                            rows="4" 
                            placeholder="Share details of your experience at this location..."
                            required
                            class="review-textarea"
                        ></textarea>
                        
                        <div class="image-upload-container">
                            <div style="margin-bottom: 15px;">
                                <p style="font-size: 14px; color: #5f6368; margin-bottom: 10px;">
                                    Add photos to your review (Max 5 images)
                                </p>
                                
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <label for="images-upload-single" class="image-upload-label">
                                        üì∑ Add Photo
                                    </label>
                                    <input type="file" id="images-upload-single" accept="image/*" class="image-upload-input">
                                    
                                    <label for="images-upload" class="image-upload-label">
                                        üìÅ Add Multiple
                                    </label>
                                    <input type="file" id="images-upload" name="images" accept="image/*" multiple class="image-upload-input" data-max="5">
                                </div>
                            </div>
                            
                            <div id="drop-area" class="drop-area">
                                <p style="margin: 0; color: #5f6368; font-size: 14px;">Or drag and drop images here</p>
                            </div>
                            
                            <div class="image-previews" id="image-previews"></div>
                        </div>
                        
                        <button type="submit" class="btn-review">Post Review</button>
                    </form>
                </div>
                {% endif %}

                <!-- Display Reviews -->
                <div class="reviews-list">
                    <h3>Community Reviews ({{ total_reviews }})</h3>
                    {% if comments %}
                        {% for comment in comments %}
                            <div class="review-item" data-comment-id="{{ comment.id }}">
                                <div class="review-header">
                                    <div class="review-avatar">{{ comment.user.username|first|upper }}</div>
                                    <div class="review-author-info">
                                        <div class="review-author">{{ comment.user.username }}</div>
                                        <div class="review-meta">
                                            <span class="review-rating">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= comment.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                                                {% endfor %}
                                            </span>
                                            <span>‚Ä¢</span>
                                            <span>{{ comment.created_at|date:"M d, Y" }}</span>
                                        </div>
                                        <div class="review-badges">
                                            {% if comment.images.count > 0 %}
                                            <span class="review-badge badge-photos">
                                                üì∑ {{ comment.images.count }} Photo{{ comment.images.count|pluralize }}
                                            </span>
                                            {% endif %}
                                            {% if comment.likes_count >= 5 %}
                                            <span class="review-badge badge-helpful">
                                                ‚≠ê Helpful
                                            </span>
                                            {% endif %}
                                            {% if comment.user.art_comments.count >= 10 %}
                                            <span class="review-badge badge-local">
                                                üèôÔ∏è Local Guide
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="review-body">{{ comment.comment }}</div>
                                
                                {% if comment.images.all %}
                                <div class="review-images">
                                    {% for image in comment.images.all %}
                                    <img src="{{ image.image.url }}" alt="Review photo" onclick="openImageModal(this.src)">
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <div class="review-actions">
                                    <button class="reaction-btn like-btn {% if comment.user_reaction_status == 'like' %}active{% endif %}" 
                                            data-comment-id="{{ comment.id }}"
                                            data-reaction="like">
                                        <span class="icon">üëç</span>
                                        <span class="count">{{ comment.likes_count }}</span>
                                    </button>
                                    <button class="reaction-btn dislike-btn {% if comment.user_reaction_status == 'dislike' %}active{% endif %}"
                                            data-comment-id="{{ comment.id }}"
                                            data-reaction="dislike">
                                        <span class="icon">üëé</span>
                                        <span class="count">{{ comment.dislikes_count }}</span>
                                    </button>
                                    <button class="reply-btn" data-comment-id="{{ comment.id }}">Reply</button>
                                    <button class="action-btn share-btn" data-comment-id="{{ comment.id }}">
                                        <span>üîó</span> Share
                                    </button>
                                    <button class="action-btn report-btn" data-comment-id="{{ comment.id }}">
                                        <span>‚ö†Ô∏è</span> Report
                                    </button>
                                </div>
                                
                                <!-- Reply Form -->
                                <div class="reply-form" id="reply-form-{{ comment.id }}">
                                    <form method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                        <textarea 
                                            name="comment" 
                                            placeholder="Write a reply..."
                                            required
                                            class="reply-textarea"
                                        ></textarea>
                                        <div class="reply-actions">
                                            <button type="button" class="btn-cancel" onclick="cancelReply('{{ comment.id }}')">Cancel</button>
                                            <button type="submit" class="btn-review">Reply</button>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Display Replies -->
                                {% if comment.replies.all %}
                                <div class="replies-container">
                                    {% for reply in comment.replies.all %}
                                    <div class="reply-item" data-comment-id="{{ reply.id }}">
                                        <div class="review-header">
                                            <div class="review-avatar">{{ reply.user.username|first|upper }}</div>
                                            <div class="review-author-info">
                                                <div class="review-author">{{ reply.user.username }}</div>
                                                <div class="review-meta">
                                                    <span>{{ reply.created_at|date:"M d, Y" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="review-body">{{ reply.comment }}</div>
                                        <div class="review-actions">
                                            <button class="reaction-btn like-btn {% if reply.user_reaction_status == 'like' %}active{% endif %}"
                                                    data-comment-id="{{ reply.id }}"
                                                    data-reaction="like">
                                                <span class="icon">üëç</span>
                                                <span class="count">{{ reply.likes_count }}</span>
                                            </button>
                                            <button class="reaction-btn dislike-btn {% if reply.user_reaction_status == 'dislike' %}active{% endif %}"
                                                    data-comment-id="{{ reply.id }}"
                                                    data-reaction="dislike">
                                                <span class="icon">üëé</span>
                                                <span class="count">{{ reply.dislikes_count }}</span>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-reviews">
                            <p>No reviews yet. Be the first to share your experience!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="detail-sidebar">
            <div class="sidebar-section">
                <h3>Quick Info</h3>
                <div class="quick-info">
                    {% if art.borough %}
                        <div class="quick-info-item">
                            <span class="quick-label">Borough</span>
                            <span class="quick-value">{{ art.borough }}</span>
                        </div>
                    {% endif %}
                    
                    {% if art.year_created %}
                        <div class="quick-info-item">
                            <span class="quick-label">Created</span>
                            <span class="quick-value">{{ art.year_created }}</span>
                        </div>
                    {% endif %}
                    
                    <div class="quick-info-item">
                        <span class="quick-label">Last Updated</span>
                        <span class="quick-value">{{ art.updated_at|date:"M d, Y" }}</span>
                    </div>
                </div>
            </div>

            {% if related_art %}
                <div class="sidebar-section">
                    <h3>Related Art</h3>
                    <div class="related-art-list">
                        {% for related in related_art %}
                            <a href="{% url 'loc_detail:art_detail' related.id %}" class="related-art-item">
                                <div class="related-art-title">{{ related.title|default:"Untitled"|truncatewords:8 }}</div>
                                <div class="related-art-artist">{{ related.artist_name|default:"Unknown"|truncatewords:4 }}</div>
                                {% if related.borough %}
                                    <div class="related-art-location">{{ related.borough }}</div>
                                {% endif %}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal-overlay" id="reportModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Report Review</h2>
            <button class="modal-close" onclick="closeReportModal()">√ó</button>
        </div>
        
        <p style="color: #5f6368; margin-bottom: 20px;">Help us understand what's wrong with this review.</p>
        
        <div class="report-reasons" id="reportReasons">
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="spam">
                <div class="reason-label">
                    <div class="reason-title">Spam or misleading</div>
                    <div class="reason-description">Promotional content, fake reviews, or misleading information</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="harassment">
                <div class="reason-label">
                    <div class="reason-title">Harassment or bullying</div>
                    <div class="reason-description">Targeting an individual with unwanted behavior</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="hate">
                <div class="reason-label">
                    <div class="reason-title">Hate speech or discrimination</div>
                    <div class="reason-description">Content promoting hatred based on identity or protected attributes</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="violence">
                <div class="reason-label">
                    <div class="reason-title">Violence or dangerous content</div>
                    <div class="reason-description">Threats, glorification of violence, or dangerous activities</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="sexual">
                <div class="reason-label">
                    <div class="reason-title">Sexual content</div>
                    <div class="reason-description">Inappropriate sexual content or exploitation</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="misinformation">
                <div class="reason-label">
                    <div class="reason-title">False information</div>
                    <div class="reason-description">Deliberately misleading or factually incorrect content</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="copyright">
                <div class="reason-label">
                    <div class="reason-title">Copyright violation</div>
                    <div class="reason-description">Unauthorized use of copyrighted material</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="personal">
                <div class="reason-label">
                    <div class="reason-title">Personal information shared</div>
                    <div class="reason-description">Sharing someone's private information without consent</div>
                </div>
            </label>
            
            <label class="reason-option">
                <input type="checkbox" name="report_reason" value="other">
                <div class="reason-label">
                    <div class="reason-title">Other</div>
                    <div class="reason-description">Something else that violates community guidelines</div>
                </div>
            </label>
        </div>
        
        <textarea 
            class="additional-info-textarea" 
            id="additionalInfo" 
            placeholder="Additional details (optional)..."
        ></textarea>
        
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeReportModal()">Cancel</button>
            <button class="btn-submit-report" onclick="submitReport()">Submit Report</button>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal-overlay" id="imageModal" onclick="closeImageModal()">
    <div class="modal-content" style="max-width: 90%; max-height: 90vh; padding: 0; background: transparent;" onclick="event.stopPropagation()">
        <button class="modal-close" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 30px; cursor: pointer; z-index: 10;" onclick="closeImageModal()">√ó</button>
        <img id="modalImage" style="max-width: 100%; max-height: 90vh; object-fit: contain; border-radius: 8px;">
    </div>
</div>

<script>
    // ========================================
    // CSRF TOKEN HELPER
    // ========================================
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // ========================================
    // DELETE EXISTING IMAGE - GLOBAL FUNCTION
    // ========================================
    function deleteExistingImage(imageId, reviewId) {
        if (!confirm('Are you sure you want to delete this image?')) {
            return;
        }
        
        console.log('üóëÔ∏è Deleting image ID:', imageId);
        
        // FIXED: Correct URL path matching urls.py
        fetch('/loc_detail/api/image/' + imageId + '/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                console.log('‚úÖ Image deleted successfully');
                // Remove the image element from DOM
                const imageItem = document.querySelector('.existing-image-item[data-image-id="' + imageId + '"]');
                if (imageItem) {
                    imageItem.style.opacity = '0';
                    setTimeout(() => imageItem.remove(), 300);
                }
                alert('Image deleted successfully');
            } else {
                console.error('‚ùå Failed to delete:', data.error);
                alert(data.error || 'Failed to delete image');
            }
        })
        .catch(error => {
            console.error('‚ùå Error:', error);
            alert('An error occurred while deleting the image');
        });
    }

    // ========================================
    // MAIN INITIALIZATION
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ Page loaded, initializing...');
        
        // ========================================
        // FAVORITE BUTTON
        // ========================================
        const favoriteBtn = document.getElementById('favorite-button');
        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', function() {
                const artId = this.getAttribute('data-art-id');
                const favoriteText = document.getElementById('favorite-text');
                
                fetch('/loc_detail/api/favorite/' + artId + '/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.favorited) {
                        favoriteBtn.classList.add('favorited');
                        favoriteText.textContent = 'Remove from Favorites';
                        alert('Added to favorites');
                    } else {
                        favoriteBtn.classList.remove('favorited');
                        favoriteText.textContent = 'Add to Favorites';
                        alert('Removed from favorites');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update favorites');
                });
            });
        }
        
        // ========================================
        // REPLY BUTTONS
        // ========================================
        document.querySelectorAll('.reply-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                const replyForm = document.getElementById('reply-form-' + commentId);
                if (replyForm) {
                    replyForm.classList.toggle('active');
                }
            });
        });
        
        // ========================================
        // FIXED LIKE/DISLIKE FUNCTIONALITY
        // ========================================
        const reactionButtons = document.querySelectorAll('.reaction-btn');
        console.log('üëç Found', reactionButtons.length, 'reaction buttons');
        
        reactionButtons.forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (this.disabled) {
                    console.log('‚è∏Ô∏è Button disabled, ignoring click');
                    return;
                }
                
                const commentId = this.getAttribute('data-comment-id');
                const reaction = this.getAttribute('data-reaction');
                
                console.log('üéØ Clicked:', reaction, 'on comment', commentId);
                
                // CRITICAL FIX: Find the CORRECT parent container
                // Use the closest review-item or reply-item
                const commentContainer = this.closest('.review-item, .reply-item');
                if (!commentContainer) {
                    console.error('‚ùå Could not find comment container');
                    return;
                }
                
                // Now find buttons WITHIN this specific container
                const allButtons = commentContainer.querySelectorAll('.reaction-btn[data-comment-id="' + commentId + '"]');
                let likeBtn = null;
                let dislikeBtn = null;
                
                allButtons.forEach(function(button) {
                    if (button.getAttribute('data-reaction') === 'like') {
                        likeBtn = button;
                    } else if (button.getAttribute('data-reaction') === 'dislike') {
                        dislikeBtn = button;
                    }
                });
                
                if (!likeBtn || !dislikeBtn) {
                    console.error('‚ùå Could not find like/dislike buttons');
                    console.log('Like button:', likeBtn);
                    console.log('Dislike button:', dislikeBtn);
                    return;
                }
                
                const likeCountSpan = likeBtn.querySelector('.count');
                const dislikeCountSpan = dislikeBtn.querySelector('.count');
                
                if (!likeCountSpan || !dislikeCountSpan) {
                    console.error('‚ùå Could not find count spans');
                    return;
                }
                
                console.log('üìä Before - Likes:', likeCountSpan.textContent, 'Dislikes:', dislikeCountSpan.textContent);
                
                // Disable buttons during request
                likeBtn.disabled = true;
                dislikeBtn.disabled = true;
                
                // Make API call
                fetch('/loc_detail/api/comment/' + commentId + '/reaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken
                    },
                    body: 'reaction=' + reaction
                })
                .then(function(response) {
                    console.log('üì° Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Server returned ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('üì¶ Response data:', data);
                    
                    if (data.success) {
                        // ‚úÖ UPDATE COUNTS IMMEDIATELY
                        likeCountSpan.textContent = data.likes;
                        dislikeCountSpan.textContent = data.dislikes;
                        
                        // ‚úÖ UPDATE ACTIVE STATES IMMEDIATELY
                        likeBtn.classList.remove('active');
                        dislikeBtn.classList.remove('active');
                        
                        if (data.user_reaction === 'like') {
                            likeBtn.classList.add('active');
                        } else if (data.user_reaction === 'dislike') {
                            dislikeBtn.classList.add('active');
                        }
                        
                        console.log('‚ú® Updated - Likes:', data.likes, 'Dislikes:', data.dislikes, 'User reaction:', data.user_reaction);
                    } else {
                        console.error('‚ùå Server returned success: false');
                        alert('Failed to update reaction');
                    }
                })
                .catch(function(error) {
                    console.error('‚ùå Error:', error);
                    alert('Failed to update reaction. Please try again.');
                })
                .finally(function() {
                    // Re-enable buttons
                    likeBtn.disabled = false;
                    dislikeBtn.disabled = false;
                    console.log('üîì Buttons re-enabled');
                });
            });
        });
        
        // ========================================
        // IMAGE UPLOAD HANDLING
        // ========================================
        function setupImageUpload(singleId, multipleId, dropAreaId, previewId) {
            let selectedFiles = [];
            const maxFiles = 5;
            const maxFileSize = 5 * 1024 * 1024; // 5MB
            
            const singleUpload = document.getElementById(singleId);
            const multipleUpload = document.getElementById(multipleId);
            const dropArea = document.getElementById(dropAreaId);
            const preview = document.getElementById(previewId);
            
            console.log('üñºÔ∏è Setting up image upload for:', previewId);
            
            if (!multipleUpload || !preview) {
                console.error('‚ùå Required upload elements not found');
                return;
            }
            
            // Single image upload
            if (singleUpload) {
                singleUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && validateFile(file)) {
                        if (selectedFiles.length >= maxFiles) {
                            alert('Maximum ' + maxFiles + ' images allowed');
                            this.value = '';
                            return;
                        }
                        selectedFiles.push(file);
                        updatePreview();
                        updateMultipleInput();
                        this.value = '';
                    }
                });
            }
            
            // Multiple images upload
            multipleUpload.addEventListener('change', function(e) {
                const newFiles = Array.from(e.target.files);
                
                if (selectedFiles.length + newFiles.length > maxFiles) {
                    alert('You can only upload up to ' + maxFiles + ' images total');
                    return;
                }
                
                for (const file of newFiles) {
                    if (validateFile(file)) {
                        selectedFiles.push(file);
                    }
                }
                
                updatePreview();
                updateMultipleInput();
            });
            
            // Drag and drop
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.classList.add('highlight');
                    });
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.classList.remove('highlight');
                    });
                });
                
                dropArea.addEventListener('drop', function(e) {
                    const dt = e.dataTransfer;
                    const files = Array.from(dt.files);
                    
                    for (const file of files) {
                        if (selectedFiles.length >= maxFiles) {
                            alert('Maximum ' + maxFiles + ' images allowed');
                            break;
                        }
                        if (validateFile(file)) {
                            selectedFiles.push(file);
                        }
                    }
                    
                    updatePreview();
                    updateMultipleInput();
                });
            }
            
            function validateFile(file) {
                if (!file.type.startsWith('image/')) {
                    alert('"' + file.name + '" is not an image file');
                    return false;
                }
                if (file.size > maxFileSize) {
                    alert('"' + file.name + '" is too large. Max size is 5MB');
                    return false;
                }
                return true;
            }
            
            function updatePreview() {
                preview.innerHTML = '';
                
                selectedFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'image-preview-item';
                        div.innerHTML = '<img src="' + e.target.result + '" alt="Preview ' + (index + 1) + '">' +
                            '<button type="button" class="remove-image-btn" onclick="window.removeImageAt_' + previewId + '(' + index + ')">√ó</button>' +
                            '<div style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">' +
                            (index + 1) + '/' + selectedFiles.length +
                            '</div>';
                        preview.appendChild(div);
                    }
                    reader.readAsDataURL(file);
                });
            }
            
            function updateMultipleInput() {
                const dt = new DataTransfer();
                selectedFiles.forEach(file => dt.items.add(file));
                multipleUpload.files = dt.files;
            }
            
            // Global remove function for this preview
            window['removeImageAt_' + previewId] = function(index) {
                selectedFiles.splice(index, 1);
                updatePreview();
                updateMultipleInput();
            };
        }
        
        // Setup both upload forms
        setupImageUpload('images-upload-single', 'images-upload', 'drop-area', 'image-previews');
        setupImageUpload('edit-images-single', 'edit-images-multiple', 'edit-drop-area', 'edit-image-previews');
        
        // ========================================
        // REPORT BUTTONS
        // ========================================
        document.querySelectorAll('.report-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                openReportModal(commentId);
            });
        });
        
        // ========================================
        // AUTO-EXPANDING TEXTAREAS
        // ========================================
        function autoExpandTextarea(textarea) {
            textarea.style.height = 'auto';
            const maxHeight = parseInt(getComputedStyle(textarea).maxHeight);
            textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
        }
        
        document.querySelectorAll('.review-textarea, .reply-textarea').forEach(textarea => {
            textarea.addEventListener('input', function() {
                autoExpandTextarea(this);
            });
            
            textarea.addEventListener('focus', function() {
                autoExpandTextarea(this);
            });
        });
    });
    
    // ========================================
    // CANCEL REPLY
    // ========================================
    function cancelReply(commentId) {
        const replyForm = document.getElementById('reply-form-' + commentId);
        if (replyForm) {
            replyForm.classList.remove('active');
        }
    }
    
    // ========================================
    // REPORT MODAL
    // ========================================
    let currentReportCommentId = null;
    
    function openReportModal(commentId) {
        currentReportCommentId = commentId;
        document.getElementById('reportModal').classList.add('active');
        document.querySelectorAll('input[name="report_reason"]').forEach(cb => cb.checked = false);
        document.getElementById('additionalInfo').value = '';
    }
    
    function closeReportModal() {
        document.getElementById('reportModal').classList.remove('active');
        currentReportCommentId = null;
    }
    
    function submitReport() {
        const reasons = Array.from(document.querySelectorAll('input[name="report_reason"]:checked')).map(cb => cb.value);
        
        if (reasons.length === 0) {
            alert('Please select at least one reason');
            return;
        }
        
        const additionalInfo = document.getElementById('additionalInfo').value;
        const submitBtn = document.querySelector('.btn-submit-report');
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        fetch('/loc_detail/api/comment/' + currentReportCommentId + '/report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                reasons: reasons,
                additional_info: additionalInfo
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeReportModal();
            } else {
                alert(data.error || 'Failed to submit report');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Report';
        });
    }
    
    // ========================================
    // IMAGE MODAL
    // ========================================
    function openImageModal(src) {
        document.getElementById('modalImage').src = src;
        document.getElementById('imageModal').classList.add('active');
    }
    
    function closeImageModal() {
        document.getElementById('imageModal').classList.remove('active');
    }
    
    // ========================================
    // ADD TO ITINERARY
    // ========================================
    const addToItineraryBtn = document.getElementById('add-to-itinerary-button');
    if (addToItineraryBtn) {
        addToItineraryBtn.addEventListener('click', function() {
            const artId = this.getAttribute('data-art-id');
            const artTitle = this.getAttribute('data-art-title');
            showAddToItineraryModal(artId, artTitle);
        });
    }
    
    function showAddToItineraryModal(locationId, locationTitle) {
        const modalHTML = '<div id="itinerary-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">' +
            '<div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">' +
            '<h3 style="margin-top: 0;">Add "' + locationTitle + '" to Itinerary</h3>' +
            '<div style="margin: 20px 0;">' +
            '<label style="display: block; margin-bottom: 10px; font-weight: bold;">Select an existing itinerary:</label>' +
            '<select id="existing-itinerary" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">' +
            '<option value="">Loading...</option>' +
            '</select>' +
            '</div>' +
            '<div style="text-align: center; margin: 15px 0; color: #666;">OR</div>' +
            '<div style="margin: 20px 0;">' +
            '<label style="display: block; margin-bottom: 10px; font-weight: bold;">Create a new itinerary:</label>' +
            '<input type="text" id="new-itinerary-title" placeholder="Enter itinerary name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">' +
            '</div>' +
            '<div style="display: flex; gap: 10px;">' +
            '<button onclick="closeItineraryModal()" style="flex: 1; padding: 10px; background: #ddd; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Cancel</button>' +
            '<button onclick="submitAddToItinerary(\'' + locationId + '\')" style="flex: 1; padding: 10px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Add</button>' +
            '</div>' +
            '<div id="itinerary-message" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>' +
            '</div>' +
            '</div>';
        
        const existingModal = document.getElementById('itinerary-modal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        fetch('/itineraries/api/user-itineraries/')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('existing-itinerary');
                if (data.itineraries && data.itineraries.length > 0) {
                    select.innerHTML = '<option value="">-- Select an itinerary --</option>' +
                        data.itineraries.map(itin => '<option value="' + itin.id + '">' + itin.title + ' (' + itin.stop_count + ' stops)</option>').join('');
                } else {
                    select.innerHTML = '<option value="">No itineraries yet</option>';
                }
            });
    }
    
    window.closeItineraryModal = function() {
        const modal = document.getElementById('itinerary-modal');
        if (modal) modal.remove();
    };
    
    window.submitAddToItinerary = function(locationId) {
        const existingItineraryId = document.getElementById('existing-itinerary').value;
        const newItineraryTitle = document.getElementById('new-itinerary-title').value.trim();
        const messageDiv = document.getElementById('itinerary-message');
        
        if (!existingItineraryId && !newItineraryTitle) {
            messageDiv.textContent = 'Please select an itinerary or create a new one';
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#fee';
            messageDiv.style.color = '#c00';
            return;
        }
        
        const formData = new FormData();
        formData.append('location_id', locationId);
        if (newItineraryTitle) {
            formData.append('new_itinerary_title', newItineraryTitle);
        } else {
            formData.append('itinerary_id', existingItineraryId);
        }
        
        fetch('/itineraries/api/add-to-itinerary/', {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.textContent = data.message;
                messageDiv.style.display = 'block';
                messageDiv.style.background = '#efe';
                messageDiv.style.color = '#060';
                setTimeout(() => closeItineraryModal(), 1500);
            } else {
                messageDiv.textContent = data.error || 'Failed to add';
                messageDiv.style.display = 'block';
                messageDiv.style.background = '#fee';
                messageDiv.style.color = '#c00';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            messageDiv.textContent = 'An error occurred';
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#fee';
            messageDiv.style.color = '#c00';
        });
    };
</script>
{% endblock %}